#include <stdio.h>
#include <elf.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/types.h>
#include <sys/mman.h>


void print_elf_header(Elf32_Ehdr *ehdr);
Elf32_Shdr* read_sections(Elf32_Off offset, uint16_t shnum);

int main(int argc, char** argv)
{
	int fd;
	struct stat st;
	uint8_t *mem;
	char* stringTable;

	Elf32_Ehdr *ehdr;
	Elf32_Phdr *phdr;
	Elf32_Shdr *shdr;


	if(argc < 2)
	{
		printf("Aucun executable passÃ© en argument!");
		return (-1);
	}

	fd = open(argv[1], O_RDONLY);
	fstat(fd, &st);

	mem = mmap(NULL, st.st_size, PROT_READ, MAP_PRIVATE, fd, 0);

	ehdr = (Elf32_Ehdr *)mem;
	printf("%p\n", ehdr->e_shoff);

	shdr = (Elf32_Shdr*)&mem[ehdr->e_shoff];
	stringTable = &mem[shdr[ehdr->e_shstrndx].sh_offset];

	printf("%d\n", ehdr->e_shstrndx);
	
	for(uint16_t cpt=0; cpt < ehdr->e_shnum; cpt++)
	{
		printf("%p\tsection %d name : %s\n", &shdr[cpt], (int)cpt, &stringTable[shdr[cpt].sh_name]);
	}

	return (0);

}
